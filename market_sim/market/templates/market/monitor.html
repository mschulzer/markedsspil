{% extends "market/base.html" %}

{% block title %}Market monitor{% endblock %}

{% block content %}
    <h1>Monitoring market</h1>
        <p>Market:{{market}}</p>
        <p>Link to join market: {% url 'market:join' %}?market_id={{market.market_id}}</p>
        <p>Active link:<a href="{% url 'market:join' %}?market_id={{market.market_id}}">Link</a></p>
        <br><br>
        <p>Round {{ market.round }}</p>
	<div id="round_number" style="display:none;">{{ market.round }}</div>
	<table id="ready">
      <thead>
        <tr>
          <th colspan="2">Players</th>
        </tr>
      </thead>
      <tbody id="ready_table_body">
      </tbody>
	</table>
	<button id="refresh">Refresher</button>
	<button id="confirm">Confirm trades</button>
        <p id="round_data"></p>
{% endblock %}
        
{% block javascript %}
    <script>
      //const csrftoken = Cookies.get('csrftoken');  In case we want to use POST instead of GET
      $("#refresh").click(function(){
              traders = []
              $.ajax({
                      type: 'GET',
                      //url: 'traders_in_market',
                      url:"{% url 'market:traders_in_market' market.market_id %}",
                      //headers: {'X-CSRFToken': csrftoken},
                      data: {},
                      dataType: 'json',
                      success: function (data) {
                              traders = data.traders;
                              trader_table = document.getElementById("ready_table_body");
                              trader_table.innerHTML = ""
                              for (var i = 0; i < traders.length; i++) {
                                      var row = trader_table.insertRow(-1);
                                      var cell = row.insertCell(0);
                                      cell.innerHTML = traders[i];
                                      cell = row.insertCell(1);
                                      cell.innerHTML = "";
                              }
                      }
              });
              $.ajax({
                      type: 'GET',
                      //url: 'traders_this_round',
                      url:"{% url 'market:traders_this_round' market.market_id %}",

                      //headers: {'X-CSRFToken': csrftoken},
                      data: {
                              'round_num': parseInt(document.getElementById("round_number").innerHTML)
                      },
                      dataType: 'json',
                      success: function (data) {
                              ready_traders = data.traders;
                              trader_table = document.getElementById("ready_table_body");
                              for (var i = 0; i < trader_table.rows.length; i++) {
                                      if (ready_traders.includes(trader_table.rows[i].cells[0].innerHTML)) {
                                              trader_table.rows[i].cells[1].innerHTML = "âœ“";
                                      }
                              }
                      }
              });
      });
      $("#confirm").click(function(){
              round_num = parseInt(document.getElementById("round_number").innerHTML);
              $.ajax({
                      type: 'GET',
                      //url: 'all_trades',
                      url:"{% url 'market:all_trades' market.market_id %}",
                      data: {
                              'round_num': round_num
                      },
                      dataType: 'json',
                      success: function (data) {
                              document.getElementById("round_data").innerHTML += round_num+" data:<br>";
                              for (var i = 0; i < data.traders.length; i++) {
                                      if (data.profit[i] > 0) {
                                              document.getElementById("round_data").innerHTML += data.traders[i] + " gained " + data.profit[i];
                                      } else {
                                              document.getElementById("round_data").innerHTML += data.traders[i] + " lost " + (-1*data.profit[i]);
                                      }
                                      document.getElementById("round_data").innerHTML += "<br>"
                              }
                              document.getElementById("round_data").innerHTML += "<br><br>"
                              document.getElementById("round_number").innerHTML = 1+parseInt(round_num);
                              trader_table = document.getElementById("ready_table_body");
                              for (var i = 0; i < trader_table.rows.length; i++) {
                                      trader_table.rows[i].cells[1].innerHTML = "";
                              }
                      }
              });
      });
    </script>
{% endblock %}
